name: CI

on:
  push:
    branches: [ main, master ]
    tags: ['*']
  pull_request:
  workflow_dispatch:

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: ${{ runner.os }}-pip-
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Run tests
        run: pytest -q
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: .pytest_cache || ''

  bandit:
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install bandit
        run: pip install bandit
      - name: Run Bandit scan
        env:
          BANDIT_FAIL_SEVERITIES: "$${{ secrets.BANDIT_FAIL_SEVERITIES || 'HIGH' }}"
        run: |
          python scripts/bandit_check.py
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: reports/bandit.json

  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v2
      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v2

  deploy:
    runs-on: ubuntu-latest
    needs: [tests, bandit, codeql]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e
            cd /var/www/workhub-backend
            echo "Git status before deploy:"
            git status -s || true
            echo "Fetching tags and branches..."
            git fetch --all --tags
            # If triggered by tag, check out that tag; otherwise update main
            if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
              TAG_NAME=${GITHUB_REF#refs/tags/}
              echo "Deploying tag: ${TAG_NAME}"
              git checkout tags/${TAG_NAME} -f || git checkout ${TAG_NAME} -f
            else
              echo "No tag detected; updating main"
              git reset --hard origin/main
            fi
            echo "Last commit deployed:"
            git log -n 1 --pretty=format:"%h - %s"
            echo "Updating dependencies..."
            /var/www/workhub-backend/venv/bin/pip install -q -r requirements.txt
            echo "Restarting service..."
            systemctl restart workhub-backend.service
            echo "âœ… Deploy completed successfully"
      - name: Upload deploy info
        uses: actions/upload-artifact@v4
        with:
          name: deploy-info
          path: deploy-info || ''
